env:
  global:
    - CC_TEST_REPORTER_ID=26015bca33836107cc047f31e74fb99fc776a569232f7b0248586c3e7d82b141
sudo: false
language: ruby
rvm:
  - 2.4
  - 2.5
before_install:
  - gem update --system --no-document
  - gem update --no-document
install:
  - gem install bundler --no-document
  - bundle install --path vendor/bundle
before_script:
  - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
  - chmod +x ./cc-test-reporter
script:
  - bundle exec rake spec
after_script:
  - ./cc-test-reporter format-coverage --output coverage/codeclimate.$TRAVIS_BUILD_NUMBER.json
  - cat coverage/codeclimate.$TRAVIS_BUILD_NUMBER.json
jobs:
  include:
    - stage: upload-coverage
      rvm: 2.5
      script:
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - echo 'in upload-coverage stage'
        - pwd
        - whoami
        - mkdir -p tmp
        - cd tmp/
        - git init first_repo
        - cd first_repo
        - git remote add -f origin https://github.com/hirura/first_repo.git
        - git config core.sparseCheckout true
        - echo "commits/commit2/" >.git/info/sparse-checkout
        - git pull origin test-orphan
        - git checkout test-orphan
        - mkdir -p commits/commit2/
        - cd commits/commit2/
        - pwd
stages:
  - test
  - upload-coverage
